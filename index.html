<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>El Impostor</title>
    
    <!-- Meta tags para parecer una App Nativa (PWA) -->
    <meta name="theme-color" content="#111827">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://emojicdn.elk.sh/üïµÔ∏è‚Äç‚ôÇÔ∏è"> 

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Bangers&display=swap" rel="stylesheet">
    <style>
        html {
            /* Color de fondo base para evitar bordes blancos al hacer rebote de scroll */
            background-color: #111827;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #f3f4f6;
            touch-action: manipulation;
            min-height: 100vh;
            /* Eliminamos overflow-hidden para permitir scroll nativo */
        }
        .font-display {
            font-family: 'Bangers', cursive;
            letter-spacing: 0.05em;
        }
        .card-enter {
            animation: slideIn 0.3s ease-out forwards;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .secret-reveal {
            background-image: radial-gradient(#374151 1px, transparent 1px);
            background-size: 20px 20px;
        }
        /* Estilo para inputs de iOS que evita el zoom */
        input, select {
            font-size: 16px !important; 
        }
        /* Padding seguro para iPhone X+ */
        .pb-safe {
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }
        .pt-safe {
            padding-top: env(safe-area-inset-top, 20px);
        }
        /* New style for simple alert box */
        #alert-box {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
    </style>
</head>
<body class="flex flex-col">

    <!-- HEADER (Sticky para que se quede arriba al scrollear) -->
    <header class="bg-gray-900/95 backdrop-blur-sm border-b border-gray-800 p-4 pt-safe sticky top-0 z-50 shadow-md">
        <div class="max-w-md mx-auto w-full flex justify-between items-center">
            <div class="flex items-center gap-2">
                <span class="text-2xl">üïµÔ∏è‚Äç‚ôÇÔ∏è</span>
                <h1 class="font-display text-2xl text-red-500 tracking-wide">EL IMPOSTOR</h1>
            </div>
            <div class="flex gap-3">
                 <button id="share-btn" onclick="shareApp()" class="hidden text-gray-400 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                    </svg>
                </button>
                <button onclick="resetGame()" class="text-xs font-bold text-gray-500 hover:text-white uppercase tracking-wider border border-gray-700 rounded px-2 py-1">
                    Reiniciar
                </button>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT AREA -->
    <!-- flex-1 permite que ocupe el espacio, pero sin restricciones de altura -->
    <main id="app" class="flex-1 w-full max-w-md mx-auto p-4 pb-safe">
        
        <!-- Alerta de Mensaje Temporal -->
        <div id="alert-box" class="fixed top-0 left-0 right-0 p-4 pt-safe z-50 transform -translate-y-full opacity-0">
            <div id="alert-message" class="max-w-md mx-auto bg-red-600 text-white p-3 rounded-lg text-sm font-semibold shadow-xl text-center">
                Mensaje de error
            </div>
        </div>
        
        <!-- PANTALLA 1: CONFIGURACI√ìN -->
        <div id="screen-setup" class="space-y-5 card-enter pb-24">
            
            <div class="bg-blue-900/20 border border-blue-800 p-4 rounded-xl text-center">
                <p class="text-blue-200 text-sm font-semibold">üì¢ ¬°Solo necesitas 1 celular!</p>
                <p class="text-blue-300/70 text-xs mt-1">Carguen los nombres y p√°sense el tel√©fono.</p>
            </div>

            <!-- Selecci√≥n de Categor√≠a -->
            <div class="bg-gray-800 p-5 rounded-2xl border border-gray-700 shadow-lg">
                <label class="block text-gray-400 text-xs font-bold uppercase tracking-wider mb-3">Categor√≠a</label>
                <div class="relative">
                    <select id="category-select" onchange="toggleCustomInput()" class="w-full bg-gray-900 text-white border-2 border-gray-700 rounded-xl p-3 focus:border-blue-500 focus:outline-none text-lg appearance-none relative z-10 bg-transparent">
                        <option value="seleccion">‚öΩ Selecci√≥n Argentina</option>
                        <option value="comidas">ü•ü Comidas T√≠picas</option>
                        <option value="lugares">üìç Lugares de Argentina</option>
                        <option value="animales">üêæ Animales</option>
                        <option value="objetos">üé∏ Objetos / Cosas</option>
                        <option value="marcas">üè∑Ô∏è Marcas Argentinas</option>
                        <option value="famosos">üì∫ Famosos Argentinos</option>
                        <option value="custom">‚úçÔ∏è Personalizado (Escribir)</option>
                        <option value="ai_prompt">üß† IA: Tema Abierto</option> <!-- Nueva Opci√≥n con IA -->
                    </select>
                    <div class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 z-0">‚ñº</div>
                </div>

                <!-- Input para palabra personalizada / IA Prompt -->
                <div id="custom-word-container" class="hidden mt-3">
                    <input type="text" id="custom-word-input" placeholder="Ej: An√©cdota del viaje 2019" class="w-full bg-gray-700 text-white border border-gray-600 rounded-xl p-3 focus:border-blue-500 focus:outline-none">
                </div>
                
                <!-- AI Instruction for Prompt -->
                <p id="ai-instruction" class="hidden text-sm text-gray-400 mt-2 p-2 bg-gray-700/50 rounded-lg border border-gray-600">
                    Escribe un tema o una restricci√≥n (Ej: "Paises que empiecen con A", "Nombres de perros", "Frutas rojas"). La IA elegir√° una palabra aleatoria.
                </p>
            </div>

            <!-- Configuraci√≥n de Jugadores -->
            <div class="bg-gray-800 p-5 rounded-2xl border border-gray-700 shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <label class="text-gray-400 text-xs font-bold uppercase tracking-wider">Jugadores</label>
                    <span id="player-count-badge" class="bg-blue-600 text-white text-xs px-2 py-1 rounded-full font-bold">3</span>
                </div>
                
                <!-- Lista de Nombres -->
                <div id="players-container" class="space-y-3 mb-4">
                    <!-- Los inputs se generan aqu√≠ -->
                    <div class="flex gap-2">
                        <span class="flex items-center justify-center w-8 text-gray-500 font-bold">1</span>
                        <input type="text" placeholder="Nombre" class="player-name-input flex-1 bg-gray-900 border border-gray-700 rounded-lg p-3 text-base focus:border-blue-500 outline-none" value="Jugador 1">
                    </div>
                    <div class="flex gap-2">
                         <span class="flex items-center justify-center w-8 text-gray-500 font-bold">2</span>
                        <input type="text" placeholder="Nombre" class="player-name-input flex-1 bg-gray-900 border border-gray-700 rounded-lg p-3 text-base focus:border-blue-500 outline-none" value="Jugador 2">
                    </div>
                    <div class="flex gap-2">
                         <span class="flex items-center justify-center w-8 text-gray-500 font-bold">3</span>
                        <input type="text" placeholder="Nombre" class="player-name-input flex-1 bg-gray-900 border border-gray-700 rounded-lg p-3 text-base focus:border-blue-500 outline-none" value="Jugador 3">
                    </div>
                </div>

                <div class="flex gap-2">
                    <button onclick="addPlayerInput()" class="flex-1 py-3 bg-gray-700 hover:bg-gray-600 rounded-xl text-sm font-bold transition flex items-center justify-center gap-2 active:bg-gray-500">
                        <span>‚ûï</span> Agregar
                    </button>
                    <button onclick="removePlayerInput()" class="px-5 py-3 bg-gray-700 hover:bg-gray-600 rounded-xl text-sm font-bold transition text-red-400 active:bg-gray-500">
                        <span>‚ûñ</span>
                    </button>
                </div>
            </div>

            <!-- Configuraci√≥n de Impostores -->
            <div class="bg-gray-800 p-5 rounded-2xl border border-gray-700 shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <label class="text-gray-400 text-xs font-bold uppercase tracking-wider">Impostores</label>
                    <div class="flex items-center gap-2 bg-gray-900 px-3 py-1 rounded-lg border border-gray-700">
                        <span class="text-xl">üë∫</span>
                        <span id="imposter-count-display" class="font-display text-xl text-red-500">1</span>
                    </div>
                </div>
                <input type="range" id="imposter-slider" min="1" max="3" value="1" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-red-500">
            </div>

            <!-- Bot√≥n Iniciar Flotante (Sticky bottom) -->
            <div class="fixed bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-gray-900 via-gray-900 to-transparent pb-safe z-40">
                 <button id="start-game-button" onclick="startGame()" class="w-full max-w-md mx-auto py-4 bg-gradient-to-r from-blue-600 to-indigo-600 active:from-blue-700 active:to-indigo-700 rounded-2xl text-white font-bold text-xl shadow-xl transform active:scale-[0.98] transition-all flex items-center justify-center gap-2 border border-blue-400/20">
                    COMENZAR üöÄ
                </button>
            </div>
        </div>

        <!-- PANTALLA 2: PASE DE DISPOSITIVO -->
        <div id="screen-pass" class="hidden flex flex-col justify-center items-center text-center space-y-8 card-enter min-h-[70vh]">
            <div class="relative">
                <div class="absolute inset-0 bg-blue-500 blur-2xl opacity-20 animate-pulse rounded-full"></div>
                <div class="bg-gray-800 p-8 rounded-3xl shadow-2xl border-4 border-gray-700 w-48 h-48 flex items-center justify-center relative z-10">
                    <span class="text-7xl">üì±</span>
                </div>
            </div>
            
            <div class="space-y-2 px-4">
                <p class="text-gray-400 text-sm uppercase tracking-widest">Dale el celular a</p>
                <h2 id="pass-player-name" class="font-display text-5xl text-white break-words leading-tight">NOMBRE</h2>
            </div>

            <button onclick="showSecret()" class="w-full max-w-xs py-5 bg-green-600 active:bg-green-700 rounded-2xl text-white font-bold text-xl shadow-lg mt-8 mx-4 transform active:scale-[0.98] transition-all">
                SOY YO üëÜ
            </button>
        </div>

        <!-- PANTALLA 3: REVELACI√ìN DE ROL -->
        <div id="screen-reveal" class="hidden flex flex-col justify-center items-center text-center relative card-enter secret-reveal p-4 min-h-[80vh]">
            
            <!-- Tarjeta de Identidad -->
            <div id="role-card" class="bg-gray-800 border-2 border-gray-600 p-8 rounded-[2rem] shadow-2xl w-full max-w-sm transform transition-all duration-300">
                <div class="mb-8">
                    <p class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-2">Tu misi√≥n es</p>
                    <h2 id="role-title" class="font-display text-5xl mb-4">CIUDADANO</h2>
                    <div id="role-icon" class="text-7xl drop-shadow-lg">üòá</div>
                </div>

                <div id="secret-word-display" class="bg-gray-900/80 rounded-2xl p-6 border border-gray-700 backdrop-blur-sm">
                    <p class="text-gray-500 text-xs uppercase mb-2 tracking-widest">Palabra Secreta</p>
                    <p id="the-secret-word" class="text-3xl font-black text-blue-400 break-words leading-tight">---</p>
                </div>
                
                <div id="imposter-msg" class="hidden bg-gradient-to-br from-red-900/40 to-red-900/10 rounded-2xl p-6 border border-red-500/30">
                    <p class="text-red-400 font-bold text-xl mb-2">¬°NO SABES NADA!</p>
                    <p class="text-red-200 text-sm">Escucha, miente y trata de adivinar la palabra secreta.</p>
                </div>
            </div>

            <button onclick="hideSecret()" class="mt-10 w-full max-w-xs py-4 bg-gray-700 active:bg-gray-600 text-white rounded-full font-bold border border-gray-500 text-lg shadow-lg mb-8">
                ENTENDIDO, PASAR üôà
            </button>
        </div>

        <!-- PANTALLA 4: JUEGO EN CURSO -->
        <div id="screen-game" class="hidden flex flex-col text-center card-enter min-h-[80vh]">
            
            <div class="flex-1 flex flex-col justify-center items-center space-y-8 px-4 mt-8">
                <div class="relative">
                    <div class="text-9xl relative z-10">üó£Ô∏è</div>
                     <div class="absolute inset-0 bg-yellow-500 blur-3xl opacity-10 rounded-full"></div>
                </div>

                <div>
                    <h2 class="font-display text-5xl text-white mb-2">¬°A DEBATIR!</h2>
                    <p class="text-gray-400 text-lg leading-relaxed">El impostor est√° entre nosotros.<br>Hagan preguntas sutiles.</p>
                </div>
                
                <!-- Info de Categor√≠a -->
                <div class="inline-flex items-center gap-2 bg-gray-800 px-5 py-2 rounded-full border border-gray-700">
                    <span class="text-gray-500 text-xs uppercase font-bold">Tema:</span>
                    <span id="game-category-display" class="text-blue-300 font-bold text-lg">F√∫tbol</span>
                </div>
            </div>

            <!-- Timer Grande -->
            <div class="mb-10 mt-8" onclick="toggleTimer()">
                <div id="timer" class="font-mono text-6xl font-bold text-gray-200 tracking-tighter tabular-nums">00:00</div>
                <p id="timer-status" class="text-xs text-blue-400 uppercase tracking-widest mt-2 animate-pulse">Tocar para iniciar</p>
            </div>

            <div class="p-4 pb-20">
                <button onclick="resetGame()" class="w-full py-4 bg-red-600/20 hover:bg-red-600/30 border border-red-600/50 rounded-2xl text-red-400 font-bold uppercase tracking-wider transition-all">
                    Terminar Partida
                </button>
            </div>
        </div>

    </main>

    <!-- LOGIC -->
    <script>
        // --- DATOS ---
        const DATABASE = {
            seleccion: ["Lionel Messi", "Dibu Mart√≠nez", "Juli√°n √Ålvarez", "√Ångel Di Mar√≠a", "Scaloni", "Kun Ag√ºero", "Maradona", "Papu G√≥mez", "Enzo Fern√°ndez", "Cuti Romero", "Mascherano", "Bochini"],
            comidas: ["Milanesa con Pur√©", "Asado", "Empanadas", "Locro", "Chorip√°n", "Alfajor", "Mate", "Fernet con Cola", "Dulce de Leche", "Tortas Fritas", "Pastel de Papa", "Pizza de Muzza"],
            lugares: ["El Obelisco", "Cataratas del Iguaz√∫", "Glaciar Perito Moreno", "La Bombonera", "Mar del Plata", "Bariloche", "Caminito", "Cerro de los 7 Colores", "Aconcagua", "Costanera Sur", "Puerto Madero", "Tren de las Nubes"],
            animales: ["Carpincho", "Hornero", "Yaguaret√©", "Ballena Franca", "C√≥ndor", "Ping√ºino", "Llama", "Puma", "Tat√∫ Carreta", "Coat√≠", "Mulita", "Guanaco"],
            objetos: ["Sube", "Termo Stanley", "Parrilla", "Bombilla", "Celular", "Bidet", "Control Remoto", "Ojotas", "Camiseta de F√∫tbol", "Sif√≥n de Soda", "Reposera", "Churros"],
            marcas: ["Manaos", "Marolio", "La Seren√≠sima", "Arcor", "Quilmes", "YPF", "Mercado Libre", "Havanna", "Tarag√ºi", "Jorgito", "Coto", "Mostaza"],
            famosos: ["Ricardo Dar√≠n", "Susana Gim√©nez", "Mirtha Legrand", "Francella", "Bizarrap", "Lali Esp√≥sito", "Fito P√°ez", "Charly Garc√≠a", "Tinelli", "Moria Cas√°n", "Sandro", "Cerati"]
        };

        // --- CONSTANTES API ---
        const API_MODEL = "gemini-2.5-flash-preview-09-2025";
        const API_KEY = "AIzaSyDfjJq93o4cVG2IOKz_H_sGNUg85nIy5f0"; 
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${API_MODEL}:generateContent?key=${API_KEY}`;


        // --- ESTADO DEL JUEGO ---
        let gameState = {
            players: [], 
            secretWord: "",
            category: "",
            currentPlayerIndex: 0,
            timerInterval: null,
            seconds: 0
        };

        // --- DOM ELEMENTS ---
        const screens = {
            setup: document.getElementById('screen-setup'),
            pass: document.getElementById('screen-pass'),
            reveal: document.getElementById('screen-reveal'),
            game: document.getElementById('screen-game')
        };
        const alertBox = document.getElementById('alert-box');
        const alertMessage = document.getElementById('alert-message');
        const customWordInput = document.getElementById('custom-word-input');
        const customWordContainer = document.getElementById('custom-word-container');
        const aiInstruction = document.getElementById('ai-instruction');
        const startGameButton = document.getElementById('start-game-button');
        const categorySelect = document.getElementById('category-select');


        // --- UTILITIES ---
        
        function showAlert(message, isError = true) {
            alertMessage.innerText = message;
            alertMessage.classList.toggle('bg-red-600', isError);
            alertMessage.classList.toggle('bg-blue-600', !isError);
            alertBox.classList.remove('-translate-y-full', 'opacity-0');
            alertBox.classList.add('translate-y-0', 'opacity-100');

            setTimeout(() => {
                alertBox.classList.remove('translate-y-0', 'opacity-100');
                alertBox.classList.add('-translate-y-full', 'opacity-0');
            }, 4000);
        }

        function setLoading(isLoading) {
            if (isLoading) {
                startGameButton.innerHTML = '<svg class="animate-spin h-5 w-5 mr-3 text-white" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> GENERANDO...';
                startGameButton.disabled = true;
                startGameButton.classList.remove('active:scale-[0.98]');
            } else {
                startGameButton.innerHTML = 'COMENZAR üöÄ';
                startGameButton.disabled = false;
                startGameButton.classList.add('active:scale-[0.98]');
            }
        }
        
        // --- FUNCIONES SETUP & PWA ---
        
        // Verificar si se puede compartir
        if (navigator.share) {
            document.getElementById('share-btn').classList.remove('hidden');
        }

        async function shareApp() {
            try {
                await navigator.share({
                    title: 'El Impostor - Juego',
                    text: '¬°Juguemos al Impostor! Entra ac√°:',
                    url: window.location.href
                });
            } catch (err) {
                console.log('Error al compartir', err);
            }
        }

        function addPlayerInput() {
            const container = document.getElementById('players-container');
            const count = container.children.length + 1;
            
            const div = document.createElement('div');
            div.className = 'flex gap-2 card-enter';
            div.innerHTML = `
                 <span class="flex items-center justify-center w-8 text-gray-500 font-bold">${count}</span>
                <input type="text" placeholder="Nombre" class="player-name-input flex-1 bg-gray-900 border border-gray-700 rounded-lg p-3 text-base focus:border-blue-500 outline-none" value="Jugador ${count}">
            `;
            container.appendChild(div);
            updateBadges();
            
            // Scroll suave hacia abajo para ver el nuevo input
            setTimeout(() => {
                window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
            }, 100);
        }

        function removePlayerInput() {
            const container = document.getElementById('players-container');
            if (container.children.length > 3) {
                container.removeChild(container.lastElementChild);
                updateBadges();
            }
        }

        function updateBadges() {
            const count = document.getElementsByClassName('player-name-input').length;
            document.getElementById('player-count-badge').innerText = count;
            
            const slider = document.getElementById('imposter-slider');
            // M√°ximo impostores es (jugadores / 2) - 1, m√≠nimo 1
            const maxImposters = Math.max(1, Math.floor((count - 1) / 2));
            slider.max = maxImposters;
            
            if (parseInt(slider.value) > maxImposters) slider.value = maxImposters;
            document.getElementById('imposter-count-display').innerText = slider.value;
        }

        document.getElementById('imposter-slider').addEventListener('input', (e) => {
            document.getElementById('imposter-count-display').innerText = e.target.value;
        });

        function toggleCustomInput() {
            if (categorySelect.value === 'custom') {
                customWordContainer.classList.remove('hidden');
                aiInstruction.classList.add('hidden');
                customWordInput.placeholder = "Ej: An√©cdota del viaje 2019";
                customWordInput.focus();
            } else if (categorySelect.value === 'ai_prompt') {
                customWordContainer.classList.remove('hidden');
                aiInstruction.classList.remove('hidden');
                customWordInput.placeholder = "Ej: Paises que empiecen con A";
                customWordInput.focus();
            } else {
                customWordContainer.classList.add('hidden');
                aiInstruction.classList.add('hidden');
            }
        }

        // --- L√ìGICA DE IA ---

        async function fetchSecretWordFromAI(prompt) {
            // Verificar si la clave de API est√° configurada
            if (API_KEY === "TU_CLAVE_API_DE_GEMINI_AQUI" || !API_KEY) {
                showAlert("Error: La clave de API de Gemini no est√° configurada. Abre el c√≥digo y reemplaza 'TU_CLAVE_API_DE_GEMINI_AQUI' con tu clave real.", true);
                return null;
            }
            
            const systemPrompt = `Eres un experto generador de palabras secretas para juegos. Tu tarea es generar UNA √öNICA palabra o frase corta (m√°ximo 4 palabras), aleatoria, que cumpla estrictamente con la restricci√≥n dada por el usuario. La respuesta debe ser solo la palabra o frase, sin explicaciones, comillas, ni texto adicional.`;
            
            const userQuery = `Dada la siguiente restricci√≥n: "${prompt}". Genera UN solo t√©rmino aleatorio que encaje.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            let attempts = 0;
            const maxAttempts = 3;
            const initialDelay = 1000; // 1 second

            while (attempts < maxAttempts) {
                try {
                    const delay = initialDelay * Math.pow(2, attempts);
                    if (attempts > 0) await new Promise(resolve => setTimeout(resolve, delay));

                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error ? errorData.error.message : response.statusText);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (text) {
                        // Limpiar el texto: remover comillas, puntos finales, y espacios extra.
                        return text.replace(/["'.\s]*$/g, '').trim();
                    } else {
                        throw new Error("Respuesta de la IA vac√≠a.");
                    }

                } catch (error) {
                    console.error(`Error en el intento ${attempts + 1}:`, error.message);
                    attempts++;
                    if (attempts === maxAttempts) {
                        return null; // Fallo total
                    }
                }
            }
        }


        // --- L√ìGICA DEL JUEGO ---

        async function startGame() {
            // Si ya est√° cargando, salir
            if (startGameButton.disabled) return;
            
            const inputs = document.getElementsByClassName('player-name-input');
            const names = Array.from(inputs).map(i => i.value.trim()).filter(n => n !== "");
            
            if (names.length < 3) return showAlert("¬°Necesitas al menos 3 jugadores!");

            const catSelect = categorySelect.value;
            let word = "";
            let catName = "";

            if (catSelect === 'custom') {
                word = customWordInput.value.trim();
                if (!word) return showAlert("Escribe una palabra personalizada.");
                catName = "Personalizada";
            } else if (catSelect === 'ai_prompt') {
                const prompt = customWordInput.value.trim();
                if (!prompt) return showAlert("Escribe un prompt para que la IA genere la palabra.");
                
                // Agregamos una verificaci√≥n de API KEY aqu√≠ tambi√©n
                if (API_KEY === "TU_CLAVE_API_DE_GEMINI_AQUI" || !API_KEY) {
                    return showAlert("Error: La clave de API de Gemini no est√° configurada.", true);
                }
                
                setLoading(true);
                word = await fetchSecretWordFromAI(prompt);
                setLoading(false);
                
                if (!word) {
                    return showAlert("No pude generar una palabra con ese prompt. Intenta con una restricci√≥n diferente o usa una categor√≠a manual.", true);
                }
                catName = `IA: ${prompt.substring(0, 30)}${prompt.length > 30 ? '...' : ''}`;
            } 
            else {
                const list = DATABASE[catSelect];
                word = list[Math.floor(Math.random() * list.length)];
                const optionText = document.querySelector(`#category-select option[value="${catSelect}"]`).text;
                // Eliminar emoji del texto para guardar solo nombre
                catName = optionText.replace(/^.\s/, ''); 
            }

            const imposterCount = parseInt(document.getElementById('imposter-slider').value);
            let roles = Array(names.length).fill('citizen');
            
            let indices = Array.from({length: names.length}, (_, i) => i);
            indices.sort(() => Math.random() - 0.5); 
            
            for (let i = 0; i < imposterCount; i++) {
                roles[indices[i]] = 'imposter';
            }

            gameState.players = names.map((name, i) => ({
                name: name,
                role: roles[i]
            }));

            gameState.secretWord = word;
            gameState.category = catName;
            gameState.currentPlayerIndex = 0;

            showScreen('pass');
            updatePassScreen();
        }

        function updatePassScreen() {
            const player = gameState.players[gameState.currentPlayerIndex];
            document.getElementById('pass-player-name').innerText = player.name;
        }

        function showSecret() {
            const player = gameState.players[gameState.currentPlayerIndex];
            const roleCard = document.getElementById('role-card');
            const roleTitle = document.getElementById('role-title');
            const roleIcon = document.getElementById('role-icon');
            const secretDisplay = document.getElementById('secret-word-display');
            const secretWord = document.getElementById('the-secret-word');
            const imposterMsg = document.getElementById('imposter-msg');

            // Reset
            roleCard.className = "p-8 rounded-[2rem] shadow-2xl border-2 w-full max-w-sm transform transition-all duration-300";
            secretDisplay.classList.remove('hidden');
            imposterMsg.classList.add('hidden');

            if (player.role === 'imposter') {
                roleTitle.innerText = "¬°IMPOSTOR!";
                roleTitle.className = "font-display text-5xl mb-4 text-red-500 animate-pulse";
                roleIcon.innerText = "üë∫";
                roleCard.classList.add('border-red-500', 'bg-gray-900');
                
                secretDisplay.classList.add('hidden');
                imposterMsg.classList.remove('hidden');
            } else {
                roleTitle.innerText = "CIUDADANO";
                roleTitle.className = "font-display text-5xl mb-4 text-blue-400";
                roleIcon.innerText = "üïµÔ∏è";
                roleCard.classList.add('border-blue-500', 'bg-gray-800');
                
                secretWord.innerText = gameState.secretWord;
            }

            showScreen('reveal');
        }

        function hideSecret() {
            gameState.currentPlayerIndex++;
            
            if (gameState.currentPlayerIndex < gameState.players.length) {
                updatePassScreen();
                showScreen('pass');
            } else {
                startRound();
            }
        }

        function startRound() {
            document.getElementById('game-category-display').innerText = gameState.category;
            showScreen('game');
            // Reset timer UI
            resetTimerUI();
        }

        function showScreen(screenName) {
            Object.values(screens).forEach(s => s.classList.add('hidden'));
            screens[screenName].classList.remove('hidden');
            // Forzar scroll al inicio
            window.scrollTo(0,0);
        }

        function resetGame() {
            stopTimer();
            showScreen('setup');
        }

        // --- TIMER ---
        let isTimerRunning = false;

        function resetTimerUI() {
            stopTimer();
            gameState.seconds = 0;
            updateTimerDisplay();
            document.getElementById('timer-status').innerText = "TOCAR PARA INICIAR";
            document.getElementById('timer-status').classList.add('animate-pulse');
        }

        function startTimer() {
            isTimerRunning = true;
            document.getElementById('timer-status').innerText = "TIEMPO CORRIENDO...";
            document.getElementById('timer-status').classList.remove('animate-pulse');
            document.getElementById('timer').classList.add('text-white');
            document.getElementById('timer').classList.remove('text-gray-200');
            
            gameState.timerInterval = setInterval(() => {
                gameState.seconds++;
                updateTimerDisplay();
            }, 1000);
        }

        function stopTimer() {
            isTimerRunning = false;
            clearInterval(gameState.timerInterval);
            document.getElementById('timer-status').innerText = "PAUSADO - TOCAR PARA SEGUIR";
            document.getElementById('timer-status').classList.add('animate-pulse');
            document.getElementById('timer').classList.remove('text-white');
            document.getElementById('timer').classList.add('text-gray-200');
        }

        function updateTimerDisplay() {
            const mins = Math.floor(gameState.seconds / 60).toString().padStart(2, '0');
            const secs = (gameState.seconds % 60).toString().padStart(2, '0');
            document.getElementById('timer').innerText = `${mins}:${secs}`;
        }

        function toggleTimer() {
            if (isTimerRunning) {
                stopTimer();
            } else {
                startTimer();
            }
        }

        // Init
        updateBadges();
        // Asegurar que el input personalizado/AI est√© oculto al inicio
        customWordContainer.classList.add('hidden');
    </script>
</body>
</html>
